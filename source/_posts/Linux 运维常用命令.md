---
title: Linux 运维常用命令
tags: [运维命令]
categories: [Linux]
date: 2025-05-09
---
### 一、df 和 du命令

`df -h` 和 `du -sh` 命令的输出之间存在差异，通常会让人感到困惑。以下是可能原因的详细解释以及排查方法：

1. **被删除但仍在使用的文件**：
   - 当文件被删除但仍有进程在使用它们时，空间不会立即释放，直到这些文件被关闭。`df` 命令会显示这些空间仍在使用，而 `du` 不会，因为 `du` 只报告当前目录结构中可见的文件。
   
   **解决方法**：使用以下命令检查带有删除标记的打开文件描述符：
   ```bash
   lsof | grep '(deleted)'
   ```
   如果找到，请考虑停止相关进程以释放空间。

2. **隐藏目录中的文件**：
   - 文件可能存储在 `du` 未扫描的隐藏目录中。

   **解决方法**：确保 `du` 扫描所有文件，包括隐藏文件：
   ```bash
   du -sh /data/*
   du -sh /data/.[!.]*
   ```

3. **/data 内的挂载点**：
   - 如果在 `/data` 目录下挂载了其他文件系统，`du` 默认不会跨越这些文件系统，而 `df` 会报告整个文件系统的使用情况。

   **解决方法**：使用 `--one-file-system` 选项确保 `du` 仅在一个文件系统内扫描：
   ```bash
   du -sh --one-file-system /data
   ```

4. **文件系统元数据**：
   - `df` 包括文件系统元数据和为 root 用户保留的空间，而 `du` 不包括。

   **解决方法**：这种使用通常很小，但如果文件系统有很多小文件，可能会很显著。虽然无法直接减少这个使用，但理解这是正常的开销可能会帮助解释一些差异。

总结排查步骤：

1. **检查被删除但打开的文件**：
   ```bash
   lsof | grep '(deleted)'
   ```

2. **检查隐藏文件**：
   ```bash
   du -sh /data/*
   du -sh /data/.[!.]*
   ```

3. **检查 /data 内的其他挂载点**：
   ```bash
   findmnt /data
   ```

4. **检查整体磁盘使用和 inode 使用情况**：
   ```bash
   df -ih /data
   ```

通过系统地检查这些方面，应该能确定 `df` 和 `du` 之间差异的原因。

